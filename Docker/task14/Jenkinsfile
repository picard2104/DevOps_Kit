pipeline {
    agent any
    
    environment {
        AWS_ACCOUNT = "090188239531"
        ECR_REPO = "task14"
        REGION = "us-east-1"
        SERVER_IP = "34.229.16.235"
    }

    stages {
        // Клонирование репозиторя
        stage('Клонирование кода') {
            steps {
                checkout scm
            }
        }

        // Этап 2: Сборка образа
        stage('Сборка образа') {
            steps {
                sh """
                cd DevOps_Kit/Docker/task14
                docker compose build nginx_proxy
                """
            }
        }

        // Этап 3: Загрузка образа в ECR
        stage('Загрузка в ECR') {
            steps {
                sh "aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin ${AWS_ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com"
                sh """
                docker tag task14-nginx_proxy ${AWS_ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPO}:latest
                docker push ${AWS_ACCOUNT}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPO}:latest
                """
            }
        }

        // Этап 4: Деплой
        stage('Деплой') {
            steps {
                sh """
                ssh ubuntu@${SERVER_IP} "
                    cd DevOps_Kit/Docker/task14
                    docker compose pull
                    docker compose up -d
                "
                """
            }
        }
    }
}
