pipeline {
  agent any
  environment {
    SERVER_IP = "34.229.16.235"
    TAG       = "${env.GIT_COMMIT.take(7)}"
    APP_DIR   = "Docker/task14"
  }
  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Build & Tag') {
      steps {
        dir(APP_DIR) {
          sh 'docker compose build nginx'
          sh "docker tag task14-nginx ${SERVER_IP}:5000/task14:${TAG}"
        }
      }
    }
    stage('Login to Registry') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'registry-creds',
          usernameVariable: 'REG_USER',
          passwordVariable: 'REG_PASS'
        )]) {
          sh '''
            echo $REG_PASS | docker login ${SERVER_IP}:5000 \
              -u $REG_USER --password-stdin
          '''
        }
      }
    }
    stage('Push Image') {
      steps {
        sh "docker push ${SERVER_IP}:5000/task14:${TAG}"
      }
    }
    stage('Deploy') {
      steps {
        sshagent(['jenkins-ssh-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
              cd ${APP_DIR} &&
              docker compose pull &&
              docker compose up -d
            '
          """
        }
      }
    }
  }
  post {
    always      { cleanWs() }
    success     { echo "Готово: http://${SERVER_IP}" }
    failure     { echo "Ошибка при выполнении CI/CD" }
  }
}

