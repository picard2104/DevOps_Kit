pipeline {
  agent any
  environment {
    REGISTRY      = "${SERVER_IP}:5000"
    REPO          = "task14"
    IMAGE         = "${REGISTRY}/${REPO}"
    TAG           = "${env.GIT_COMMIT.take(7)}"
    APP_DIR       = "DevOps_Kit/Docker/task14"
    SERVER_IP     = "34.229.16.235"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Build & Tag') {
      steps {
        dir(APP_DIR) {
          sh 'docker compose build nginx'
          sh "docker tag nginx ${IMAGE}:${TAG}"
        }
      }
    }
    stage('Login to Registry') {
      steps {
        withCredentials([usernamePassword(
            credentialsId: 'registry-creds',
            usernameVariable: 'REG_USER',
            passwordVariable: 'REG_PASS'
        )]) {
          sh "echo \$REG_PASS | docker login ${REGISTRY} -u \$REG_USER --password-stdin"
        }
      }
    }
    stage('Push Image') {
      steps {
        sh "docker push ${IMAGE}:${TAG}"
      }
    }
    stage('Deploy') {
      steps {
        sshagent(['jenkins-ssh-key']) {
          sh """
            ssh -o StrictHostKeyChecking=no ubuntu@${SERVER_IP} '
              cd ${APP_DIR} &&
              docker compose pull &&
              docker compose up -d
            '
          """
        }
      }
    }
  }
  post {
    always { cleanWs() }
    success { echo "Pipeline успешно завершён, приложение доступно по http://${SERVER_IP}" }
    failure { echo "Pipeline завершился с ошибкой" }
  }
}

